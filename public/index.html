<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Network Dashboard</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <header style="border-bottom: 1px solid #75FF38;">
        <nav class="navbar navbar-expand-lg navbar-dark">
            <h1 style="display: inline-table; color: #F6F0F4;"><span style="color: #75FF38">Dash</span>board</h1>
            <div>
                <div style="display: inline-table; float: right;">
                    <button onclick="logout()" class="b-filled" style="">Abmelden</button>
                </div>
                <!-- <a href="./login.html" style="display: inline-table; float: right; margin-right: 1rem">
                    <button class="b-outline" style="">Optionen</button>
                </a> -->
            </div>
        </nav>
    </header>

    <section id="devices" class="container" style="padding-top: 3rem; padding-bottom: 3rem;">
        <div class="row" style="text-align: center;">
            <h2 style="color: #F6F0F4;">MEIN NETZWERK</h2>
            <hr>
        </div>

        <!-- <button onclick="scanNetwork()">Network</button>
        <input id="network_ip" type="text" placeholder="Netzwerk-IP"><span>/</span>
        <input id="network_suffix" type="text" placeholder="Suffix"> -->

        <p class="text-green" id="network_results"></p>
        
        <!-- <button onclick="scanDetailed()">Detail</button>
        <input id="detail_ip" type="text" placeholder="Device-IP">
        <p class="text-green" id="detail_results"></p> -->

        
        <div class="row">
            <table id="t-devices">
            </table>
        </div>
    </section>

    <footer id="footer" class="py-3">

        <p>© 2021</p>
        <small>Daniel Schleicher</small>
        <small>Jeremias Renner</small>
        <small>Leon Hubert-Grivic</small>

    </footer>

    <script>
        let state = {};

        scanNetwork();

        function logout() {
            window.localStorage.removeItem('dash_tkn');
            window.location.href = "/login.html";
        }

        function scanNetwork() {
            document.getElementById('network_results').innerText = "Scanne Netzwerk...";
            const token = window.localStorage.getItem('dash_tkn');
            if(token) {
                fetch(`/scan/network`, {
                    method: "get",
                    headers: new Headers({
                        'Authorization': `Bearer ${token}`
                    })
                })
                .then(response => {
                    console.log(response);
                    if(response.ok)
                        return response.json()
                    else {
                        if(response.status === 401) {
                            logout();
                        }
                    }
                })
                .then(data => {
                    console.log(data);
                    document.getElementById('network_results').innerText = ""; //for debugging: JSON.stringify(data);
                    formatNetwork(data);
                    state = data;
                })
                .catch((err) => {
                    console.log(err);
                });
            } else {
                logout();
            }
        }
        
        function scanDetailed(deviceID, ip) {
            if(document.getElementById(`detail-button-d${deviceID}`).innerText === "Detailscan") {
                document.getElementById(`detail-button-d${deviceID}`).innerText = "Scanne Gerät...";
                const token = window.localStorage.getItem('dash_tkn');
                if(token) {
                    fetch(`/scan/detail/${ip}`, {
                        method: "get",
                        headers: new Headers({
                            'Authorization': `Bearer ${token}`
                        })
                    })
                    .then(response => {
                        console.log(response);
                        if(response.ok)
                            return response.json()
                        else {
                            if(response.status === 401) {
                                logout();
                            }
                        }
                    })
                    .then(data => {
                        console.log(data);
                        document.getElementById(`detail-button-d${deviceID}`).innerText = "Details ausblenden";
                        // document.getElementById(`detail-button-d${deviceID}`).removeEventListener("click", () => scanDetailed(deviceID, data.ip));
                        // document.getElementById(`detail-button-d${deviceID}`).addEventListener("click", () => hideDetails(deviceID, data.ip));
                        // document.getElementById(`detail-button-d${deviceID}`).onclick = `() => hideDetails('${deviceID}', '${ip}')`;
                        console.log("Helo");
                        formatDetails(deviceID, data);
                    })
                    .catch((err) => {
                        console.log(err);
                    });
                } else {
                    logout();
                }
            } else if(document.getElementById(`detail-button-d${deviceID}`).innerText === "Details ausblenden") {
                hideDetails(deviceID, ip);
            } else {
                console.log("trying abort");
            }
        }

        function hideDetails(deviceID, ip) {
            console.log("HIAFS");
            // const foundDetails = document.getElementsByClassName(`detail-row-d${deviceID}`);
            removeElementsByClassName(`detail-row-d${deviceID}`);
            // console.log(foundDetails, foundDetails.toString());
            // for (const detailRow of foundDetails) {
            //     console.log("removing", JSON.stringify(detailRow));
            //     detailRow.remove();
            // }
            document.getElementById(`detail-button-d${deviceID}`).innerText = "Detailscan";
            // document.getElementById(`detail-button-d${deviceID}`).removeEventListener("click", () => hideDetails(deviceID, ip));
            // document.getElementById(`detail-button-d${deviceID}`).addEventListener("click", () => scanDetailed(deviceID, ip));
        }

        function removeElementsByClassName(className){
            const elements = document.getElementsByClassName(className);
            while(elements.length > 0){
                elements[0].parentNode.removeChild(elements[0]);
            }
        }

        function formatNetwork(resultData) {
            const devicesTable = document.getElementById("t-devices");
            devicesTable.innerHTML = "";
            for (let i = 0; i < resultData.length; i++) {
                deviceTR = document.createElement("tr");
                deviceTR.innerHTML = 
                        `<td class="py-3">`
                    +       `<a id="b-dropdown-d${i}" class="b-dropdown" data-toggle="collapse" href="#collapse-d${i}" role="button" aria-expanded="false" aria-controls="collapse-d${i}">`
                    +           `<span class="b-dropdow">&#9660;  </span><h3 id="d${i}" style="display: inline-block;">${resultData[i].hostname ? resultData[i].hostname : (resultData[i].ip ? resultData[i].ip : (resultData[i].mac ? resultData[i].mac : "Unbekanntes Gerät"))}</h3>`
                    +       `</a>`
                    +       `<div class="t-device collapse" id="collapse-d${i}">`
                    +           `<table id="t${i}">`
                    +               `<tr><td class="device-network">MAC</td><td>${resultData[i].mac ? resultData[i].mac : "?"}</td></tr>\n`
                    +               `<tr><td class="device-network">IP</td><td>${resultData[i].ip ? resultData[i].ip : "?"}</td></tr>\n`
                    +               `<tr><td class="device-network">Vendor</td><td>${resultData[i].vendor ? resultData[i].vendor : "?"}</td></tr>`
                    +           `</table>`
                    +           `<div style="text-align: center; padding: 10px 0">`
                    +               `<button id="detail-button-d${i}" class="b-filled-orange" onclick="scanDetailed('${i}', '${resultData[i].ip}')">Detailscan</button>`
                    +           `</div>`
                    +       `</div>`
                    +   `</td>`;
                console.log(deviceTR.innerHTML.toString());
                devicesTable.appendChild(deviceTR);
            }
        }
        function formatDetails(deviceID, resultData) {          
            let i = 0;
            // console.log(resultData[i].openPorts && resultData[i].openPorts);
                document.getElementById(`d${deviceID}`).innerText = resultData[i].hostname ? resultData[i].hostname : "?";
                document.getElementById(`t${deviceID}`).innerHTML =
                      `<tr><td class="device-network">MAC</td><td>${resultData[i].mac ? resultData[i].mac : "?"}</td></tr>\n`
                    + `<tr><td class="device-network">IP</td><td>${resultData[i].ip ? resultData[i].ip : "?"}</td></tr>\n`
                    + `<tr><td class="device-network">Vendor</td><td>${resultData[i].vendor ? resultData[i].vendor : "?"}</td></tr>\n`
                    + `<tr class="detail-row-d${deviceID}"><td colspan="2"><hr></td></tr>`
                    + `<tr class="detail-row-d${deviceID}"><td class="device-detail">OS</td><td>${resultData[i].osNmap ? resultData[i].osNmap : "?"}</td></tr>\n`
                    + `<tr class="detail-row-d${deviceID}"><td class="device-detail">Offene Ports</td><td>${resultData[i].openPorts ? formatPorts(resultData[i].openPorts) : "?"}</td></tr>`;
        }
        function formatPorts(resultDataPorts) {
            console.log(resultDataPorts);
            let formatted = `<div class="t-ports"><table>`;
            for (let i = 0; i < resultDataPorts.length; i++) {
                formatted +=
                  ``
                
                + `<tr><td class="device-detail">Port</td><td>${resultDataPorts[i].port ? resultDataPorts[i].port : "?"}</td></tr>\n`
                + `<tr><td class="device-detail">Protokol</td><td>${resultDataPorts[i].protocol ? resultDataPorts[i].protocol : "?"}</td></tr>\n`
                + `<tr><td class="device-detail">Dienst</td><td>${resultDataPorts[i].service ? resultDataPorts[i].service : "?"}</td></tr>\n`
                + `${(i < resultDataPorts.length - 1) ? '<tr><td colspan="2"><hr class="light"></td></tr>' : ''}`
                + ``
            }
            return formatted + "</table></div>";
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>

</html>